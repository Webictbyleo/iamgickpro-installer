# Backend Environment Override Fix - Complete

## Overview
Fixed the backend setup phase to prevent overriding the installer-generated `.env` file with the source repository's `.env` file, which contained incompatible messenger configuration.

## Problem Analysis
The installation process was:
1. **Environment Phase**: Generate `.env` with `MESSENGER_TRANSPORT_DSN=doctrine://default`
2. **Backend Setup Phase**: Copy source `.env` over generated one with `MESSENGER_TRANSPORT_DSN=doctrine://default?auto_setup=0`
3. **Database Phase**: Try to create schema but fail due to `auto_setup=0` parameter

## Root Cause
The backend setup phase was copying the source repository's `.env` file over the installer-generated configuration:

```bash
# PROBLEMATIC: Overwrote installer-generated .env
cp "$backend_source/.env" "$backend_dest/.env"
```

This replaced the correctly configured environment file with the source repository's development configuration.

## Solution
Removed the `.env` file copying from backend setup phase:

```bash
# OLD: Copy source .env (problematic)
cp "$backend_source/.env" "$backend_dest/.env"

# NEW: Use installer-generated .env (correct)
# Note: .env file is already generated by environment configuration phase
```

## Why This Works

### 1. Proper Configuration Flow
- **Phase 4**: Environment configuration generates production-ready `.env`
- **Phase 5**: Backend setup copies code but preserves installer `.env`
- **Phase 7**: Database setup uses correct messenger configuration

### 2. Prevents Configuration Conflicts
- **Source `.env`**: May have development settings, `auto_setup=0`, etc.
- **Installer `.env`**: Has production settings tuned for installation
- **Result**: Clean, consistent configuration

### 3. Maintains Installation Context
- User input is properly reflected in configuration
- Database credentials match what was configured
- Messenger transport is compatible with installation process

## Technical Details

### Environment Configuration Precedence
1. **Installer-generated `.env`** - Production configuration
2. **Source `.env.example`** - Template (not copied)
3. **Source `.env`** - Development configuration (ignored)

### Messenger Transport Configuration
- **Installer**: `MESSENGER_TRANSPORT_DSN=doctrine://default`
- **Source**: `MESSENGER_TRANSPORT_DSN=doctrine://default?auto_setup=0`
- **Result**: Schema creation works without transport issues

### File Exclusion Pattern
```bash
rsync --exclude=.env*
# Excludes:
# - .env
# - .env.local
# - .env.example
# - .env.production
```

## Files Modified
- `phases/05-backend-setup.sh` - Removed source `.env` copying

## Benefits
- ✅ **Consistent Configuration**: Installer settings preserved
- ✅ **No Environment Conflicts**: Source settings don't interfere
- ✅ **Proper Messenger Setup**: Compatible transport configuration
- ✅ **Installation Success**: Database schema creation works

## Validation
- ✅ Script syntax validated
- ✅ Environment configuration flow correct
- ✅ No source `.env` override
- ✅ Messenger transport compatible

The backend setup now properly respects the installer-generated environment configuration and doesn't override it with potentially incompatible source repository settings.
